## Slide 1
# UEFI & EDK II Training

## Changing PCDs with Windows Labs


<a href='http://www.tianocore.org'>tianocore.org</a>



---  

## Slide 2 Lesson Objective

### Lesson Objective 

- UEFI Application with PCDs


---
## Slide 3  EDK II PCD’s Purpose and Goals
<br>
<p align="center"><b>EDK II PCD’s Purpose and Goals</b> - REVIEW</p>
Documentaton :  <a href="https://github.com/tianocore/edk2/blob/master/MdeModulePkg/Universal/PCD/Dxe/Pcd.inf"> MdeModulePkg/Universal/PCD/Dxe/Pcd.inf  </a> 

Purpose

- Establishes platform common definitions 
- Build-time/Run-time aspects 
- Binary Editing Capabilities 

Goals

- Simplify porting 
- Easy to associate with a module or platform 

Note:

---



## Slide 4 PCD Syntax review
### <p align="center">PCD Syntax  - REVIEW 
PCDs can be located anywhere within the Workspace even though a different package will use those PCDs for a given project</span>

Note:

- The Platform configuration database is generated by the build process parsing the build description files that define and specify PCD entries.

- What we see on this slide is how the PCD data is being used in various levels of the build description files

- First we have the DEC file – this Defines a list of PCD tokens that modules can use. 
 	It Defines the PCD entries that will exist under the GUID for that  package, the PCD restriction, valid types for the PCD, and a default value for the PCD. There is a whole syntax and how to define a PCD in the DEC file.

- Next we have PCB entries in the INF file- and this Defines the usage of PCD tokens by the module.
	It Defines what PCD entries are being used within the module, the PCD restriction (or DYNAMIC for none), and a Optional default value for the PCD within this module only.

- Next is the DSC file – This is at the Platform level and describes the contents of the build for a specific platform. 
	PCD entries are assigned values and types for the platform build. You would define a value here to be used by that platform. The value could be different when it is defined in the DEC file but the value in the DSC would be the final value . And They Cannot conflict with established restrictions.

- Not on this slide but also there is the FDF build description File – and this file would have flash layout related values 
---
## Slide 5  Writing UEFI Applications with PCDs

### Lab 1: Writing UEFI Applications with PCDs

In this lab, you’ll  learn how to write UEFI applications with PCDs.

Note:

Solution: Lab_Material_FW/FW/LabSampleCode/LabSolutions/LessonB.1



---
## Slide 6  EDK II HelloWorld  App  Lab 
<b>EDK II HelloWorld  App  Lab  </b></p>

First Setup for Building EDK II for Emulator, See <a href="https://github.com/tianocore-training/Presentation_FW/blob/main/FW/Presentations/Lab_Guides/_C_01_Platform_Build_Win_Emulator_Lab_guide.md#slide-10--titlelab-1--build-emulator-section">Lab Setup for Emulator </a>

Locate and Open <br>
`edk2/MdeModulePkg/Application/HelloWorld/HelloWorld.c`

Notice the PCD values
<br>
<br>
<br>
Build Emulation <br>
Then Run HelloWorld at the Shell command interface 

Note:

- So the steps for getting the source code, hopefully everyone did this prior to this training because it does take some time to download.
- So here are the steps:

- First create a directory, and for our example case we are using the directory "~src/Fw/edk2-ws"  Linux or

"C:\Fw\edk2-ws" Windows

---



 

## Slide 7   EDK II HelloWorld  App  Lab steps
<p align="left"><b>EDK II HelloWorld  App  Lab  </b></p>

Open a VS  Command Prompt and type: `cd C:\FW\edk2-ws` then 
```shell

  C:/FW/edk2-ws> Setenv.bat
  C:/FW/edk2-ws> cd edk2
  C:/FW/edk2-ws/edk2> edksetup.bat

```
Build the EmulatorPkg for Windows X64 (run WinHost.exe from Build/EmulatorX64/ . . ./X64 )


```shell
  C:/FW/edk2-ws/edk2> Build 
  C:/FW/edk2-ws/edk2> RunEmulator.bat
```
At the UEFI Shell prompt
```shell
Shell> Helloworld
UEFI Hello World!
Shell> 
```

<font color="green">**How can we force the HelloWorld application to print out 3 times ?**</font>


Note:
RunEmulator.bat will run WinHost.exe from Build/EmulatorX64/DEBUG_TAG/X64 

---
## Slide 8  EDK II HelloWorld  App  Lab location
### <b>EDK II HelloWorld  App  Lab  </b>

<a href="https://github.com/tianocore/edk2/tree/master/MdeModulePkg/Application/HelloWorld"> MdeModulePkg/Application/HelloWorld </a>


Note:

First let's look at the source code for the HellowWorld Application

---
## Slide 9  EDK II HelloWorld  App  Lab code
### <b>EDK II HelloWorld  App  Lab  </b> 

<span style="font-size:01.0em" >Source: <font color="green">Helloworld.c</font></span>

```C++
EFI_STATUS
EFIAPI
UefiMain (
  IN EFI_HANDLE        ImageHandle,
  IN EFI_SYSTEM_TABLE  *SystemTable
  )
{
	UINT32 Index;
	Index = 0;
  // Three PCD type (FeatureFlag, UINT32 
  // and String) are used as the sample.
  if (FeaturePcdGet (PcdHelloWorldPrintEnable)) {
  	for (Index = 0; Index < PcdGet32   (PcdHelloWorldPrintTimes); Index ++) {
  	  
  	  // Use UefiLib Print API to print
      // string to UEFI console
  	  
    	Print ((CHAR16*)PcdGetPtr (PcdHelloWorldPrintString));
    }
  }

  return EFI_SUCCESS;
}
```

Note:


Source from Helloworld.c 

---

## Slide 10    EDK II HelloWorld  App  Lab solution
### <b>EDK II HelloWorld  App  Solution </b> 


Note:

- look in file: `C:\fw\edk2\MdeModulePkg\MdeModulePkg.Dec`

- This PCD defines the print string.
-  This PCD is a sample to explain String typed PCD usage.
-  `gEfiMdeModulePkgTokenSpaceGuid.PcdHelloWorldPrintString|L"UEFI Hello World!\n"|VOID*|0x40000004`

Solution:
1. Edit the file C:/FW/edk2-ws/edk2/EmulatorPkg/EmulatorPkg.dsc
  - After the section [PcdsFixedAtBuild], add the new line :  
  - `[PcdsFixedAtBuild]`

  Add
```
 gEfiMdeModulePkgTokenSpaceGuid.PcdHelloWorldPrintTimes|3
```
2. Re-Build Cd to FW/edk2 dir 

```
bash$ build 
``` 


---
## SLide 11  EDK II HelloWorld  App  Lab solution 02
### <b>EDK II HelloWorld  App  Solution </b> 


Note:

3. RunEmulator.bat

4. At the Shell prompt
```
 Shell> Helloworld
 UEFI Hello World!
 UEFI Hello World!
 UEFI Hello World!
 Shell> 
```
5. Exit with Reset at the shell

- How can we change the string of the HelloWorld application?
- Also see  ~src/edk2/MdeModulePkg/MdeModulePkg.Dec

---
## Slide 12 2: Writing UEFI Applications with PCDs

### Lab 1_2: Writing UEFI Applications with PCDs

In this lab, you’ll learn how to change a PCD String in the HelloWorld UEFI applications.


Note:

Solution: Lab_Material_FW/FW/LabSampleCode/LabSolutions/LessonB.1_2


---

## Slide 13  EDK II HelloWorld App Change String
### <b>EDK II HelloWorld App Change String </b> 


Note:

- look in file: `C:\fw\edk2\MdeModulePkg\MdeModulePkg.Dec`

- This PCD defines the print string.
-  This PCD is a sample to explain String typed PCD usage.
-  `gEfiMdeModulePkgTokenSpaceGuid.PcdHelloWorldPrintString|L"UEFI Hello World!\n"|VOID*|0x40000004`

Solution:
1. Edit the file C:/FW/edk2-ws/edk2/EmulatorPkg/EmulatorPkg.dsc
  - After the section [PcdsFixedAtBuild], add the new line :  
  - `[PcdsFixedAtBuild]`
  - `gEfiMdeModulePkgTokenSpaceGuid.PcdHelloWorldPrintTimes|3`

Add
```
  gEfiMdeModulePkgTokenSpaceGuid.PcdHelloWorldPrintString|L"My New String!\n"
```
2. Re-Build – Cd to FW/edk2 dir 

```
bash$ build 
```

---
## SLide 14  EDK II HelloWorld  App  Lab solution 02
### <b>EDK II HelloWorld  App  Solution </b> 


Note:

3. RunEmulator.bat

4. At the Shell prompt
```shell
 Shell> Helloworld
 My New String!
 My New String!
 My New String!
 Shell> 
```
5. Exit with Reset at the shell


---
## Slide 15 3: Adding PCD String

### Lab 1_3: Adding PCD String


In this lab, you’ll add a PCD String to the previous lab's SampleApp UEFI Shell application


Note:

Solution: Lab_Material_FW/FW/LabSampleCode/LabSolutions/LessonB.1_3


---
## Slide 16 Lab 1_3: Catch Up SampleApp

### <b>Lab 1_3: Catch up from previous lab</b>

Skip to next slide if Lab Writing UEFI App Lab</a> completed - <a href="https://github.com/tianocore-training/Presentation_FW/blob/main/FW/Presentations/Lab_Guides/_C_03_Writing_UEFI_App_WIN_LabGuide.md"> Labguide </a> <BR>

- Perform Lab Setup from previous Labs  <a href="https://github.com/tianocore-training/Presentation_FW/blob/main/FW/Presentations/Lab_Guides/_C_01_Platform_Build_Win_Emulator_Lab_guide.md">LabGuide</a>  
- Create a Directory under the workspace `C:/FW/edk2-ws/edk2 : "SampleApp"`
- Copy contents of `C:/../FW/LabSampleCode/SampleAppPCD to C:/FW/edk2-ws/edk2/SampleApp`
- Open `C:/FW/edk2-ws/edk2/EmulatorPkg/EmulatorPkg.dsc`
- Add the following to the `[Components]` section: 

```
 # Add new modules here
SampleApp/SampleApp.inf
```
<br>
- Save and close the file `C:/FW/edk2-ws/edk2/EmulatorPkg/EmulatorPkg.dsc`


---
## Slide 17 Sample App Add PCD String

### <b>Sample App Add PCD String</b>

How can we add a string to the SampleApp application?

1. Edit the file C:/FW/edk2-ws/edk2/EmulatorPkg/EmulatorPkg.dec. After the section [PcdsFixedAtBuild] add the PCD for the SampleApp called: `PcdSampleAppString`
2. Edit the file C:/FW/edk2-ws/edk2/SampleApp.inf and add the new PCD in the PCD section. Also add the package EmulatorPkg.dec in the Package section
3. Edit the file C:/FW/edk2-ws/edk2/SampleApp.c and add the correct Library include and also add:
```
// PCD LAB after #include <Uefi.h> add the following Include
#include <Library/PcdLib.h>
//
// . . .
//
// Add after start of UefiMain 
	Print((CHAR16 *)PcdGetPtr(PcdSampleAppString));
```
4. Re-Build – Cd to C:/FW/edk2-ws/edk2
```
$> Build
```

---
## Slide 18 EDK II SampleApp Test

### <b>EDK II SampleApp Test</b>

5. Run Emulation (run WinHost.exe from Build/EmulatorX64/ . . ./X64 )
```
  C:/FW/edk2-ws/edk2> RunEmulator.bat
```
6. At the Shell prompt
```shell
Shell> SampleApp
SampleApp String

. . .
Shell> 
```
7. Exit Emulation
```shell
Shell> Reset
```





---  
## Slide 19 Summaryy
<BR>
<p align="left"><span class="gold"   >Summary  <br>

- UEFI Application with PCDs

 

---
## SLide 20 Questions
<br>


---
## Slide 21 Return to Training


Return to Training Table of contents for next presentation link: https://github.com/tianocore-training/Tianocore_Training_Contents/wiki



---
## Slide 22  Logo Slide
<br><br><br>


---
## SLide 23 Acknowledgements
<p align="left"><span class="gold"   >Acknowledgements 

```c++
/**
Redistribution and use in source (original document form) and 'compiled' forms (converted
to PDF, epub, HTML and other formats) with or without modification, are permitted provided
that the following conditions are met:

Redistributions of source code (original document form) must retain the above copyright 
notice, this list of conditions and the following disclaimer as the first lines of this 
file unmodified.

Redistributions in compiled form (transformed to other DTDs, converted to PDF, epub, HTML
and other formats) must reproduce the above copyright notice, this list of conditions and 
the following disclaimer in the documentation and/or other materials provided with the 
distribution.

THIS DOCUMENTATION IS PROVIDED BY TIANOCORE PROJECT "AS IS" AND ANY EXPRESS OR IMPLIED 
WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND 
FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL TIANOCORE PROJECT BE 
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES 
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, 
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
ARISING IN ANY WAY OUT OF THE USE OF THIS DOCUMENTATION, EVEN IF ADVISED OF THE POSSIBILITY 
OF SUCH DAMAGE.

Copyright (c) 2022, Intel Corporation. All rights reserved.
**/

```
